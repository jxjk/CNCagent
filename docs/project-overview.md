# CNCagent 项目概述

## 项目简介

CNCagent是一个CNC代码编写助手，旨在将CAD图纸转换为G代码，以自动化和优化数控机床的编程流程。该项目提供了一个完整的解决方案，从图纸导入、特征识别、G代码生成到模拟验证。

## 项目目标

- **自动化编程**: 将CAD图纸自动转换为G代码，减少手动编程时间
- **特征识别**: 智能识别图纸中的几何特征（如孔、口袋、槽等）
- **参数化设计**: 支持宏变量，实现设计参数的动态调整
- **模拟验证**: 提供G代码模拟功能，验证加工路径的正确性
- **可扩展性**: 模块化设计，便于功能扩展和维护

## 核心功能

### 1. 图纸导入与解析
- 支持多种CAD文件格式（PDF, DXF, SVG, DWG, STEP, IGES）
- 自动解析几何元素和尺寸标注
- 提供OCR功能处理扫描图纸

### 2. 特征识别与定义
- 交互式特征选择功能
- 支持多种特征类型（孔、口袋、槽、倒角、圆角等）
- 参数化特征定义

### 3. G代码生成
- 基于特征的自动化G代码生成
- 支持多种数控系统指令
- 优化刀具路径

### 4. 模拟与验证
- G代码执行模拟
- 碰撞检测
- 加工时间估算

### 5. 代码导出
- 标准G代码格式输出
- 支持多种数控系统格式
- 参数化输出

## 系统架构

### 架构概览

CNCagent采用模块化架构设计，主要包括以下组件：

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   用户界面      │◄──►│   API服务层      │◄──►│   状态管理器    │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                               │
                    ┌─────────────────────────────┐
                    │      核心处理模块           │
                    │  ┌─────────────────────────┐│
                    │  │  图纸解析模块           ││
                    │  └─────────────────────────┘│
                    │  ┌─────────────────────────┐│
                    │  │  特征定义模块           ││
                    │  └─────────────────────────┘│
                    │  ┌─────────────────────────┐│
                    │  │  G代码生成模块          ││
                    │  └─────────────────────────┘│
                    │  ┌─────────────────────────┐│
                    │  │  模拟输出模块           ││
                    │  └─────────────────────────┘│
                    └─────────────────────────────┘
```

### 核心组件

#### 1. 状态管理器 (CNCStateManager)
- **功能**: 管理整个应用的状态转换
- **状态流**: 
  - waiting_import → drawing_loaded → processing → ready
  - ready → feature_selected → defining_feature → code_generated
  - code_generated → simulation_running → code_exported
- **职责**: 
  - 控制工作流程状态
  - 协调各模块间的数据传递
  - 确保状态转换的合法性

#### 2. 项目初始化模块 (projectInitialization.js)
- **功能**: 创建和管理项目实例
- **核心类**: Project
- **职责**:
  - 初始化项目对象
  - 管理工作区文件
  - 处理图纸导入

#### 3. 图纸解析模块 (subprocesses/pdfParsingProcess.js)
- **功能**: 解析各种CAD格式文件
- **技术栈**: pdfjs-dist, tesseract.js
- **职责**:
  - 解析几何元素
  - 提取尺寸信息
  - 生成几何数据结构

#### 4. 特征定义模块 (featureDefinition.js)
- **功能**: 识别和定义CAD特征
- **核心功能**:
  - 特征选择算法
  - 特征类型定义
  - 宏变量关联
- **支持的特征类型**:
  - hole, pocket, boss, slot
  - chamfer, fillet, extrude, cut

#### 5. G代码生成模块 (gCodeGeneration.js)
- **功能**: 根据定义的特征生成G代码
- **生成逻辑**:
  - 程序开头/结尾代码
  - 特征特定G代码
  - 刀具路径优化
- **支持的操作**:
  - 钻孔、铣削、切割等

#### 6. 模拟输出模块 (simulationOutput.js)
- **功能**: G代码模拟和输出
- **核心功能**:
  - G代码执行模拟
  - 工具路径可视化
  - 代码验证和导出

### 技术栈

- **运行环境**: Node.js v16+
- **Web框架**: Express.js
- **文件处理**: pdfjs-dist, tesseract.js
- **安全防护**: express-rate-limit
- **测试框架**: Jest
- **包管理**: npm

### 设计模式

- **状态模式**: 状态管理器实现状态转换
- **模块化设计**: 各功能模块独立封装
- **工厂模式**: 项目对象创建
- **责任链模式**: API请求处理链

## 数据流

1. **图纸导入**: 文件 → 解析 → 几何数据
2. **特征识别**: 几何数据 → 特征选择 → 特征定义
3. **代码生成**: 特征定义 → G代码生成 → 代码块
4. **模拟验证**: G代码 → 模拟执行 → 验证结果
5. **代码导出**: 验证后代码 → 格式化 → 输出文件

## 安全特性

- 输入验证和清理
- XSS防护
- 请求频率限制
- 文件类型验证
- 安全的文件操作