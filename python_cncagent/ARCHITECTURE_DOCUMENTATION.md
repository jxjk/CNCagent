# CNC Agent 架构文档

## 1. 系统概述

CNC Agent 是一个 AI 辅助的从 PDF 图纸自动生成 FANUC NC 程序的 Python 实现。系统设计遵循模块化、可扩展和高内聚低耦合的原则。

## 2. 架构层次

```
┌─────────────────────────────────────────────────────────┐
│                    用户界面层 (UI)                        │
├─────────────────────────────────────────────────────────┤
│                    API 服务层 (API)                      │
├─────────────────────────────────────────────────────────┤
│                    业务逻辑层 (Business Logic)            │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────┐ │
│  │  特征识别模块      │ │  G代码生成模块     │ │  配置管理器    │ │
│  │  (feature_def)  │ │  (gcode_gen)    │ │  (config)   │ │
│  └─────────────────┘ └─────────────────┘ └─────────────┘ │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────┐ │
│  │  材料匹配模块     │ │  PDF处理模块     │ │  验证模块     │ │
│  │  (material_match)│ │  (pdf_process)  │ │  (validation)│ │
│  └─────────────────┘ └─────────────────┘ └─────────────┘ │
├─────────────────────────────────────────────────────────┤
│                    AI/ML 服务层 (AI Services)           │
├─────────────────────────────────────────────────────────┤
│                    数据访问层 (Data Access)              │
└─────────────────────────────────────────────────────────┘
```

## 3. 模块架构

### 3.1 核心模块

#### 3.1.1 特征定义模块 (feature_definition.py)
- **职责**: 从图像中识别几何形状，如圆形、矩形、多边形等
- **输入**: 图像数据、图纸文本
- **输出**: 几何特征列表
- **依赖**: OpenCV, NumPy, 配置模块
- **关键功能**:
  - 形状识别 (圆形、矩形、多边形等)
  - 沉孔特征识别
  - 坐标系统调整
  - 特征过滤和验证

#### 3.1.2 G代码生成模块 (gcode_generation.py)
- **职责**: 根据识别的特征和用户描述生成符合FANUC标准的G代码
- **输入**: 几何特征、用户描述分析
- **输出**: FANUC NC程序
- **依赖**: 配置模块、刀具映射、螺纹参数
- **关键功能**:
  - 钻孔代码生成
  - 攻丝代码生成
  - 沉孔代码生成
  - 铣削代码生成
  - 安全指令生成

#### 3.1.3 材料工具匹配模块 (material_tool_matcher.py)
- **职责**: 分析用户描述并提取工艺参数
- **输入**: 用户描述
- **输出**: 工艺参数字典
- **依赖**: 正则表达式、机械制图专家模块
- **关键功能**:
  - 加工类型识别
  - 刀具需求分析
  - 工艺参数提取
  - 孔位置识别

#### 3.1.4 PDF处理模块 (pdf_parsing_process.py)
- **职责**: PDF到图像转换和OCR处理
- **输入**: PDF文件路径
- **输出**: 图像列表、文本内容
- **依赖**: PyMuPDF、PIL、Tesseract
- **关键功能**:
  - PDF转图像
  - OCR文本识别
  - 文本提取

### 3.2 辅助模块

#### 3.2.1 配置管理模块 (config.py)
- **职责**: 统一管理所有配置参数
- **关键功能**:
  - 图像处理参数
  - 特征识别参数
  - G代码生成参数
  - 验证参数

#### 3.2.2 验证模块 (validation.py)
- **职责**: 输入验证和数据验证
- **关键功能**:
  - 特征验证
  - 用户描述验证
  - 参数验证
  - NC程序验证

#### 3.2.3 机械制图专家模块 (mechanical_drawing_expert.py)
- **职责**: 理解机械制图规则和标准
- **关键功能**:
  - 图纸信息解析
  - 视图识别
  - 尺寸标注理解
  - 技术要求解析

## 4. 数据流架构

```
PDF文件
   ↓
PDF处理模块 (pdf_parsing_process.py)
   ↓
图像数据 + 文本内容
   ↓
特征识别模块 (feature_definition.py)
   ↓
几何特征列表
   ↓
用户描述分析 (material_tool_matcher.py)
   ↓
工艺参数
   ↓
G代码生成模块 (gcode_generation.py)
   ↓
NC程序
   ↓
验证模块 (validation.py)
   ↓
最终输出
```

## 5. 设计模式

### 5.1 工厂模式
- 在AI驱动生成器中使用，用于创建不同类型的处理对象

### 5.2 策略模式
- 坐标系统选择策略（highest_y, lowest_y, leftmost_x等）

### 5.3 单例模式
- 配置管理器，确保全局配置一致性

### 5.4 装饰器模式
- 异常处理和日志记录

## 6. 安全架构

### 6.1 输入验证层
- 所有外部输入在使用前进行验证
- 文件路径规范化和范围检查
- 文本内容净化

### 6.2 依赖隔离
- 第三方库使用沙箱模式
- 异常处理防止崩溃

### 6.3 访问控制
- 文件系统访问限制
- 临时文件安全清理

## 7. 错误处理架构

```
外部输入
   ↓
输入验证 (validation.py)
   ↓
异常捕获 (exceptions.py)
   ↓
统一处理 (handle_exception)
   ↓
日志记录 (logging)
   ↓
用户反馈
```

## 8. 扩展性设计

### 8.1 插件式架构
- AI驱动生成器支持多种AI模型
- OCR处理支持多种引擎
- 输出格式支持多种标准

### 8.2 配置驱动
- 算法参数可通过配置调整
- 支持不同机床类型
- 可定制加工工艺

## 9. 性能优化

### 9.1 缓存策略
- 配置信息缓存
- 计算结果缓存
- 图像处理结果缓存

### 9.2 并发处理
- 图像处理并行化
- 特征识别优化
- 内存管理优化

## 10. 测试策略

### 10.1 单元测试
- 每个模块独立测试
- 边界条件测试
- 异常路径测试

### 10.2 集成测试
- 模块间接口测试
- 端到端流程测试
- 性能基准测试

### 10.3 安全测试
- 输入验证测试
- 路径遍历测试
- 异常注入测试