# CNC Agent 重构规划文档

## 项目概述

当前的CNC Agent项目使用混合方法生成NC程序，包括传统图像处理、OCR推理和AI驱动方法。根据最新需求，我们需要重构项目，抛弃传统的NC程序生成方法，直接调用大模型根据提示词生成NC代码。PDF图纸提取的特征仅作为辅助参考信息。

## 当前架构分析

### 主要模块
1. `ai_driven_generator.py` - AI驱动的NC程序生成模块
2. `ocr_ai_inference.py` - OCR与AI推理模块
3. `unified_generator.py` - 统一CNC程序生成入口
4. `gcode_generation.py` - FANUC NC代码生成模块（传统方法）
5. `feature_definition.py` - 几何特征识别模块（传统方法）

### 当前流程
1. PDF解析与OCR处理
2. 几何特征识别
3. 用户描述理解
4. 特征与描述匹配
5. 传统方法生成NC代码
6. AI方法作为补充

## 重构目标

### 1. 抛弃传统NC生成方法
- 移除或大幅简化`gcode_generation.py`和`feature_definition.py`中的传统算法
- 不再依赖几何特征识别作为生成NC代码的主要依据
- 将用户描述作为生成NC代码的主要输入

### 2. 直接调用大模型生成
- 使用大语言模型直接根据用户提示词生成NC代码
- 设计高质量的提示词模板，确保生成的NC代码符合FANUC标准
- 实现智能错误处理和代码验证机制

### 3. PDF特征作为辅助参考
- PDF特征提取仍保留，但仅作为辅助信息
- 特征信息用于增强提示词，而非作为生成的主要依据
- 确保用户需求优先于图纸信息

## 重构方案

### 阶段1：核心模块重构
1. **AI驱动生成器重构** (`ai_driven_generator.py`)
   - 移除传统代码生成逻辑
   - 实现大模型API调用接口
   - 设计优化的提示词工程

2. **统一生成器重构** (`unified_generator.py`)
   - 调整优先级，确保AI方法为主
   - 简化传统方法作为备用选项

### 阶段2：提示词工程设计
1. **用户需求解析**
   - 精确解析用户加工需求
   - 提取加工类型、尺寸、位置等关键信息

2. **上下文增强**
   - 将PDF提取的特征信息作为上下文增强
   - 确保用户需求优先级最高

3. **NC代码生成模板**
   - 设计标准的NC代码生成模板
   - 确保符合FANUC编程规范

### 阶段3：验证与优化
1. **代码验证机制**
   - 实现生成代码的验证机制
   - 确保生成的NC代码符合标准

2. **错误处理**
   - 大模型调用失败时的降级策略
   - 输入验证与格式化

## 风险与挑战

### 1. 大模型API依赖
- **风险**: 依赖外部API可能导致可用性问题
- **缓解**: 实现本地模型部署选项和备用方案

### 2. 生成代码质量
- **风险**: 大模型可能生成不符合FANUC标准的代码
- **缓解**: 实现严格的代码验证机制和后处理

### 3. 成本控制
- **风险**: 频繁调用大模型API可能产生高额费用
- **缓解**: 实现缓存机制和API调用优化

## 实施计划

### 第1周：架构设计与核心模块重构
- 重新设计`ai_driven_generator.py`
- 实现基本的大模型调用接口

### 第2周：提示词工程与优化
- 开发高质量的提示词模板
- 实现用户需求解析模块

### 第3周：集成与测试
- 修改`unified_generator.py`以优先使用AI方法
- 实现代码验证机制

### 第4周：性能优化与文档更新
- 优化性能和错误处理
- 更新相关文档

## 预期收益

1. **生成质量提升**: 大模型能够生成更符合工业标准的NC代码
2. **开发效率**: 减少复杂的传统算法实现和维护
3. **灵活性**: 能够处理更复杂的加工需求
4. **可扩展性**: 易于添加新的加工类型和功能

## 成功标准

1. 生成的NC代码100%符合FANUC编程标准
2. 用户需求满足率达到95%以上
3. 生成速度在可接受范围内（<10秒）
4. 系统稳定性达到99.5%以上

---
**产品经理**: [待填写]
**日期**: 2025年12月25日
**版本**: 1.0