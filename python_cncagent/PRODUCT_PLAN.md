# CNC Agent 产品方案 - 基于风险评估的调整

## 项目概述

CNC Agent 是一个 AI 驱动的从 PDF 图纸、3D 模型自动生成 FANUC NC 程序的 Python 实现项目。根据风险评估结果，我们在重构项目时需要特别关注安全性和可靠性。项目将直接调用大模型根据提示词生成NC代码，PDF图纸和3D模型提取的特征仅作为辅助参考信息。

## 风险评估总结

### 1. 技术架构风险
- **大模型API依赖** - 依赖外部API可能导致可用性问题
- **生成代码质量** - 大模型可能生成不符合FANUC标准的代码
- **成本控制** - 频繁调用大模型API可能产生高额费用
- **性能瓶颈** - AI推理可能成为系统性能瓶颈

### 2. AI集成相关风险
- **输入处理风险** - 恶意输入可能导致AI系统异常或生成不安全代码
- **API调用安全** - API密钥管理和调用频率限制
- **模型偏差** - AI模型可能出现偏差，影响代码生成准确性
- **API故障** - 依赖第三方AI API，存在不可控的停机风险

### 3. 安全和输入验证风险
- **文件上传安全** - PDF和图像上传可能包含恶意内容
- **路径遍历攻击** - 文件处理过程可能存在路径遍历漏洞
- **注入攻击** - 用户描述处理可能面临注入攻击风险
- **输出验证不足** - 生成的NC代码可能未经充分验证

## 调整后的产品方案

### 1. 分层安全架构
- 实现多层输入验证和过滤机制
- 添加文件内容安全性检查
- 增强API调用的错误处理和重试机制

### 2. 混合生成策略
- 主要使用AI模型生成NC代码
- 保留传统方法作为安全备选方案
- 实现代码验证和安全检查双重保障

### 3. 本地优先策略
- 优先考虑本地AI模型部署
- 实现缓存机制减少API调用频率
- 增加成本控制和使用量监控功能

## 当前架构分析

### 主要模块
1. `ai_driven_generator.py` - AI驱动的NC程序生成模块
2. `ocr_ai_inference.py` - OCR与AI推理模块
3. `unified_generator.py` - 统一CNC程序生成入口
4. `gcode_generation.py` - FANUC NC代码生成模块（传统方法）
5. `feature_definition.py` - 几何特征识别模块（传统方法）
6. `model_3d_processor.py` - 3D模型处理模块
7. `nc_code_validator.py` - NC代码验证器
8. `feature_completeness_evaluator.py` - 特征完整性评估模块
9. `geometric_reasoning_engine.py` - 几何推理引擎
10. `prompt_builder.py` - 智能提示词构建器
11. `requirement_clarifier.py` - 需求澄清模块

### 当前流程
1. PDF解析与OCR处理
2. 3D模型特征提取
3. 几何特征识别
4. 用户描述理解
5. 特征与描述匹配
6. 特征完整性评估
7. 智能提示词构建
8. AI方法生成NC代码
9. 代码验证与安全检查

## 重构目标

### 1. AI优先但安全可控
- 使用大语言模型直接根据用户提示词生成NC代码
- 设计高质量的提示词模板，确保生成的NC代码符合FANUC标准
- 实现智能错误处理和代码验证机制
- 保留传统方法作为安全备选方案

### 2. 多模态信息融合
- PDF特征提取仍保留，但仅作为辅助信息
- 3D模型特征提取增强，提供更精确的几何信息
- 特征信息用于增强提示词，而非作为生成的主要依据
- 确保用户需求优先于图纸信息
- 实现几何推理引擎，支持复杂特征分析

### 3. 增强安全性
- 实现严格的输入验证机制
- 增加文件内容安全检查
- 添加API调用频率限制
- 实现输出代码安全性验证

### 4. 智能化处理
- 实现智能提示词构建，融合多源信息
- 增强需求澄清能力，处理信息不完整情况
- 支持多种3D格式处理
- 实现几何推理和工艺规划

## 重构方案

### 阶段1：安全架构重构
1. **输入验证模块增强** (`validation.py`)
   - 添加文件内容安全性检查
   - 实现路径遍历防护
   - 增强用户描述输入的过滤机制

2. **代码验证模块** (`nc_code_validator.py`)
   - 实现严格的NC代码验证机制
   - 添加安全指令检查
   - 确保生成代码符合工业安全标准

### 阶段2：核心模块重构
1. **AI驱动生成器重构** (`ai_driven_generator.py`)
   - 实现大模型API调用接口
   - 设计优化的提示词工程
   - 添加API故障降级策略
   - 实现成本控制机制

2. **统一生成器重构** (`unified_generator.py`)
   - 调整优先级，确保AI方法为主
   - 保留传统方法作为安全备选选项
   - 实现智能故障转移机制

3. **3D模型处理增强** (`model_3d_processor.py`)
   - 支持更多3D格式（STL、STEP、IGES、OBJ、PLY）
   - 提取更精确的几何特征
   - 实现3D到2D特征映射

### 阶段3：智能化功能增强
1. **几何推理引擎开发** (`geometric_reasoning_engine.py`)
   - 实现复杂几何特征分析
   - 支持腔槽、螺纹、齿轮等复杂特征识别
   - 实现工艺规划和切削参数优化
   - 实现加工可行性分析

2. **智能提示词构建** (`prompt_builder.py`)
   - 实现多源信息融合
   - 智能构建AI生成所需的提示词
   - 确保语义对齐和信息一致性
   - 嵌入工艺专业知识

3. **需求澄清模块** (`requirement_clarifier.py`)
   - 实现信息完整性评估
   - 生成针对性问题引导用户提供必要信息
   - 实现智能信息补充机制

### 阶段4：提示词工程设计
1. **用户需求解析**
   - 精确解析用户加工需求
   - 提取加工类型、尺寸、位置等关键信息
   - 实现需求澄清和补充机制

2. **多模态信息融合**
   - 将PDF、3D模型提取的特征信息作为上下文增强
   - 实现3D信息与2D图纸信息的融合
   - 确保用户需求优先级最高
   - 实现语义对齐和多模态信息一致性

3. **NC代码生成模板**
   - 设计标准的NC代码生成模板
   - 确保符合FANUC编程规范
   - 添加安全和错误处理指令
   - 支持复杂加工工艺

### 阶段5：安全和可靠性增强
1. **安全检查机制**
   - 实现生成代码的安全性验证
   - 添加危险指令检测
   - 确保代码符合安全操作规范

2. **容错和降级**
   - 大模型调用失败时的降级策略
   - 传统方法作为备选方案
   - 实现平滑的故障转移

3. **性能优化**
   - 实现缓存机制
   - 优化API调用频率
   - 实现异步处理机制

## 风险缓解措施

### 1. API依赖风险缓解
- **本地模型部署**: 实现本地AI模型选项
- **API故障处理**: 实现API调用失败时的降级策略
- **缓存机制**: 实现结果缓存减少重复调用
- **成本监控**: 实现API使用量监控和预算控制

### 2. 安全风险缓解
- **输入验证**: 严格的输入验证和过滤
- **文件安全**: 文件内容安全检查和病毒扫描
- **代码验证**: 生成代码的严格验证
- **访问控制**: API密钥管理和访问限制

### 3. 代码质量风险缓解
- **双重验证**: AI生成代码 + 传统方法验证
- **标准符合性**: 严格的FANUC标准验证
- **测试覆盖**: 增加测试用例确保代码质量
- **人工审核**: 关键应用可选人工审核流程

### 4. 智能化处理风险缓解
- **特征完整性评估**: 自动评估图纸信息的完整性
- **交互式查询**: 智能引导用户提供必要信息
- **几何推理验证**: 使用几何推理引擎验证AI生成结果

## 实施计划

### 第1周：安全架构重构
- 增强`validation.py`输入验证模块
- 实现`nc_code_validator.py`代码验证器
- 添加文件内容安全检查机制

### 第2周：核心模块重构
- 重新设计`ai_driven_generator.py`
- 实现基本的大模型调用接口
- 添加API故障降级策略

### 第3周：3D模型处理增强
- 增强`model_3d_processor.py`模块
- 实现多格式3D模型支持
- 添加3D到2D特征映射功能

### 第4周：几何推理引擎开发
- 开发`geometric_reasoning_engine.py`模块
- 实现复杂几何特征分析功能
- 实现工艺规划和参数优化

### 第5周：智能提示词构建
- 开发`prompt_builder.py`智能提示词构建器
- 实现多源信息融合机制
- 开发`requirement_clarifier.py`需求澄清模块

### 第6周：统一生成器和集成测试
- 修改`unified_generator.py`以优先使用AI方法
- 实现智能故障转移机制
- 进行全面的安全和功能测试

### 第7周：提示词工程与优化
- 开发高质量的提示词模板
- 实现多源信息融合
- 优化生成性能和准确性

### 第8周：性能优化与文档更新
- 优化性能和错误处理
- 更新相关文档
- 实施监控和日志记录

## 预期收益

1. **生成质量提升**: 大模型能够生成更符合工业标准的NC代码
2. **开发效率**: 减少复杂的传统算法实现和维护
3. **灵活性**: 能够处理更复杂的加工需求
4. **安全性**: 增强的安全机制确保系统可靠性
5. **可扩展性**: 易于添加新的加工类型和功能
6. **可靠性**: 混合策略确保系统高可用性
7. **智能化**: 支持多种输入格式和智能信息融合
8. **用户友好**: 支持信息不完整情况下的智能交互

## 成功标准

1. 生成的NC代码100%符合FANUC编程标准
2. 用户需求满足率达到95%以上
3. 系统安全性和可靠性达到99.5%以上
4. 生成速度在可接受范围内（<15秒）
5. API调用成本控制在预算范围内
6. 安全漏洞数量为零
7. 支持多种3D格式（STL、STEP、IGES、OBJ、PLY）
8. 实现智能信息补充机制
9. 支持复杂几何特征识别和加工

---
**产品经理**: [待填写]
**日期**: 2025年12月26日
**版本**: 2.1