# CNC Agent 大模型生成架构设计

## 架构概览

新的架构将围绕大语言模型（LLM）为核心，构建一个从用户需求到NC代码的直接转换系统。PDF特征提取仅作为辅助信息，不参与主要的代码生成逻辑。

```
[用户需求] + [PDF辅助信息] → [提示词工程] → [大模型调用] → [NC代码生成] → [验证与优化]
```

## 核心组件设计

### 1. 提示词工程系统

#### 1.1 用户需求解析器
- 输入: 用户原始需求描述
- 输出: 结构化的加工需求
- 功能:
  - 识别加工类型（钻孔、沉孔、攻丝、铣削等）
  - 提取几何参数（直径、深度、位置等）
  - 解析材料和工艺要求
  - 识别特殊加工要求

#### 1.2 PDF特征增强器
- 输入: PDF提取的特征信息
- 输出: 增强的上下文信息
- 功能:
  - 整合PDF中的尺寸信息
  - 提取材料规格
  - 识别图纸中的加工要求
  - 作为辅助上下文，但优先级低于用户需求

#### 1.3 提示词生成器
- 输入: 结构化需求 + PDF辅助信息
- 输出: 优化的提示词
- 功能:
  - 生成符合大模型输入格式的提示词
  - 包含FANUC编程规范指导
  - 确保用户需求优先级最高

### 2. 大模型接口层

#### 2.1 模型适配器
- 支持多种大模型API（OpenAI GPT、Claude、自部署模型等）
- 统一的调用接口
- 错误处理和重试机制

#### 2.2 会话管理器
- 管理与大模型的交互会话
- 实现上下文保持和历史记录
- 优化API调用成本

### 3. NC代码生成器

#### 3.1 代码后处理器
- 对大模型生成的代码进行格式化
- 确保符合FANUC标准
- 添加必要的安全指令

#### 3.2 代码验证器
- 验证生成的NC代码语法正确性
- 检查安全参数（安全高度、进给速度等）
- 标识潜在的加工风险

## 数据流设计

### 主流程
```
1. 用户提交需求
2. 需求解析器分析文本
3. PDF特征提取（可选）
4. 提示词生成器构建完整提示
5. 调用大模型生成NC代码
6. 后处理器格式化代码
7. 验证器验证代码质量
8. 返回生成的NC代码
```

### 错误处理流程
```
1. 大模型调用失败 → 使用备用方案
2. 生成代码验证失败 → 重新生成或返回错误
3. 用户需求解析失败 → 请求澄清或使用默认参数
```

## API设计

### 1. 核心接口

```python
class LLMCNCGenerator:
    def generate_nc_code(
        self,
        user_prompt: str,
        pdf_features: Optional[Dict] = None,
        model_params: Optional[Dict] = None
    ) -> NCGenerationResult:
        """
        使用大模型生成NC代码
        
        Args:
            user_prompt: 用户需求描述
            pdf_features: PDF提取的辅助特征
            model_params: 大模型参数配置
            
        Returns:
            NCGenerationResult: 生成结果
        """
        pass
```

### 2. 数据模型

```python
@dataclass
class ProcessingRequirements:
    """加工需求结构"""
    processing_type: str  # 加工类型
    dimensions: Dict      # 尺寸参数
    positions: List[Tuple[float, float]]  # 位置信息
    material: str         # 材料
    depth: float          # 深度
    tool_diameter: float  # 刀具直径
    special_requirements: List[str]  # 特殊要求

@dataclass
class NCGenerationResult:
    """NC代码生成结果"""
    nc_code: str          # 生成的NC代码
    success: bool         # 生成是否成功
    confidence: float     # 置信度
    errors: List[str]     # 错误信息
    warnings: List[str]   # 警告信息
```

## 安全与质量保证

### 1. 代码安全检查
- 检查生成的G代码是否包含危险指令
- 验证坐标系统设置是否正确
- 确保安全高度和回退操作

### 2. 参数验证
- 检查进给速度是否在合理范围
- 验证主轴转速是否合适
- 确认刀具选择是否正确

### 3. 生成质量评估
- 比较生成代码与标准模板的相似度
- 检查是否包含必要的初始化和结束指令
- 验证加工循环的正确性

## 扩展性设计

### 1. 模型切换支持
- 可轻松切换不同大模型提供商
- 本地模型部署支持
- 模型性能监控

### 2. 提示词模板管理
- 可配置的提示词模板
- 针对不同加工类型的专门模板
- 模板版本控制

### 3. 生成策略配置
- 可配置的生成策略
- 不同精度要求的生成模式
- 成本优化选项

## 性能优化

### 1. 缓存机制
- 缓存常见加工类型的生成结果
- 缓存提示词模板
- 智能缓存策略

### 2. 批处理支持
- 支持批量生成NC代码
- 并发处理多个请求
- 资源利用率优化

## 部署考虑

### 1. 云服务部署
- 支持主流云平台部署
- 自动扩缩容
- API调用限制管理

### 2. 本地部署
- 支持本地大模型部署
- 离线处理能力
- 资源占用优化

---
**架构师**: Python专家
**日期**: 2025年12月25日
**版本**: 1.0